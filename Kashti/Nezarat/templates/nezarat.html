{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">

  <!-- ุณุฑุจุฑฺฏ ุตูุญู -->
  <div class="page-header text-white mb-4 p-4 shadow" 
       style="background: linear-gradient(135deg, #6a11cb, #2575fc); border-radius: .5rem;">
    <h2 class="fw-bold">๐โ๐จ ูพูู ูุธุงุฑุช ุฌุงูุน</h2>
    {% if expired_message %}
      <div class="alert alert-warning mt-3 shadow-sm">
        {{ expired_message }}
      </div>
    {% endif %}
  </div>

  <!-- ฺฉุงุฑุชโูุง ุขูุงุฑ -->
  <div class="row g-2 mb-3">
    <div class="col-md-2">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <h6 class="text-muted">ฺฉุดุชโูุง</h6>
          <div class="display-6 text-primary">{{ stats.ships }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <h6 class="text-muted">ุงูุจุงุฑูุง</h6>
          <div class="display-6 text-success">{{ stats.warehouses }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <h6 class="text-muted">ูุทุนุงุช</h6>
          <div class="display-6 text-warning">{{ stats.parts }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <h6 class="text-muted">ุณูุฑูุง</h6>
          <div class="display-6 text-info">{{ stats.transports }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <h6 class="text-muted">ฺฉุงุฑููุฏุงู</h6>
          <div class="display-6 text-danger">{{ stats.employees }}</div>
        </div>
      </div>
    </div>
  </div>


  <!-- ุชุจโูุง (Nav Pills) -->
  <ul class="nav nav-pills mb-3" id="nezaratTabs" role="tablist" style="border-bottom: 1px solid #000000;">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="employees-tab" data-bs-toggle="tab" data-bs-target="#employees-panel" type="button" role="tab" aria-controls="employees-panel" aria-selected="true">
        ฺฉุงุฑููุฏุงู
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="ships-tab" data-bs-toggle="tab" data-bs-target="#ships-panel" type="button" role="tab" aria-controls="ships-panel" aria-selected="false">
        ฺฉุดุชโูุง
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="ship-parts-tab" data-bs-toggle="tab" data-bs-target="#ship-parts-panel" type="button" role="tab" aria-controls="ship-parts-panel" aria-selected="false">
        ูุทุนุงุช ุฑู ฺฉุดุช
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="parts-tab" data-bs-toggle="tab" data-bs-target="#parts-panel" type="button" role="tab" aria-controls="parts-panel" aria-selected="false">
        ูุทุนุงุช
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="warehouses-tab" data-bs-toggle="tab" data-bs-target="#warehouses-panel" type="button" role="tab" aria-controls="warehouses-panel" aria-selected="false">
        ุงูุจุงุฑูุง
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="subwarehouses-tab" data-bs-toggle="tab" data-bs-target="#subwarehouses-panel" type="button" role="tab" aria-controls="subwarehouses-panel" aria-selected="false">
        ุฒุฑุงูุจุงุฑูุง ุงูุจุงุฑ
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="ship-subwarehouses-tab" data-bs-toggle="tab" data-bs-target="#ship-subwarehouses-panel" type="button" role="tab" aria-controls="ship-subwarehouses-panel" aria-selected="false">
        ุฒุฑุงูุจุงุฑูุง ฺฉุดุช
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="transport-tab" data-bs-toggle="tab" data-bs-target="#transport-panel" type="button" role="tab" aria-controls="transport-panel" aria-selected="false">
        ุณูุฑูุง
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="reminders-tab" data-bs-toggle="tab" data-bs-target="#reminders-panel" type="button" role="tab" aria-controls="reminders-panel" aria-selected="false">
        ุงุฏุขูุฑโูุง
      </button>
    </li>
  </ul>

  <div class="tab-content" id="nezaratTabsContent">

    <!-- 1) ฺฉุงุฑููุฏุงู -->
    <div class="tab-pane fade show active" id="employees-panel" role="tabpanel" aria-labelledby="employees-tab">
      <h5 class="mb-2">ฺฉุงุฑููุฏุงู ุดุฑฺฉุช</h5>
      <input id="employeeSearch" type="text" class="form-control form-control-sm mb-2" placeholder="ุฌุณุชุฌู ุฏุฑ ฺฉุงุฑููุฏุงู...">
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle" id="employeeTable">
          <thead class="table-secondary">
            <tr>
              <th>#</th>
              <th>ูุงู ฺฉุงุฑุจุฑ</th>
              <th>ุฌุงฺฏุงู</th>
              <th>ุนููุงุช</th>
            </tr>
          </thead>
          <tbody>
            {% for me in employees %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ me.employee.user.username }}</td>
                <td>{{ me.position }}</td>
                <td>
                  <button class="btn btn-sm btn-primary disabled">ูุฑุงุด</button>
                  <button class="btn btn-sm btn-danger disabled">ุญุฐู</button>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-center text-muted">ูฺ ฺฉุงุฑููุฏ ุซุจุช ูุดุฏู</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- 2) ฺฉุดุชโูุง -->
    <div class="tab-pane fade" id="ships-panel" role="tabpanel" aria-labelledby="ships-tab">
      <h5 class="mb-2">ฺฉุดุชโูุง ุดุฑฺฉุช</h5>
      <input id="shipSearch" type="text" class="form-control form-control-sm mb-2" placeholder="ุฌุณุชุฌู ุฏุฑ ฺฉุดุชโูุง...">
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle" id="shipTable">
          <thead class="table-secondary">
            <tr>
              <th>#</th>
              <th>ูุงู ฺฉุดุช</th>
              <th>ุชูุถุญุงุช</th>
              <th>ุนููุงุช</th>
            </tr>
          </thead>
          <tbody>
            {% for ship in ships %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ ship.name }}</td>
                <td>{{ ship.description|default:"โ" }}</td>
                <td>
                  <!-- ุฏฺฉูู ูุฑุงุด ููุฏุงู -->
                  <button class="btn btn-sm btn-primary" onclick="openShipModal({{ ship.id }})">ูุฑุงุด ููุฏุงู</button>
                  <!-- ุฏฺฉูู ุญุฐู Ajax -->
                  <button class="btn btn-sm btn-danger" onclick="deleteShipAjax({{ ship.id }}, event)">ุญุฐู Ajax</button>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-center text-muted">ูฺ ฺฉุดุช ุซุจุช ูุดุฏู</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- 3) ูุทุนุงุช ุฑู ฺฉุดุช (ShipPart) -->
    <div class="tab-pane fade" id="ship-parts-panel" role="tabpanel" aria-labelledby="ship-parts-tab">
      <h5 class="mb-2">ูุทุนุงุช ูุตุจโุดุฏู ุฑู ฺฉุดุช</h5>
      <p class="text-muted">ุฏุฑ ุตูุฑุช ูุงุฒุ ุงูฺฏู ุจุงูุง ุฑุง ุชฺฉุฑุงุฑ ฺฉูุฏ (ุฌุณุชุฌู + ุฌุฏูู).</p>
    </div>

    <!-- 4) ูุทุนุงุช (Part) -->
    <div class="tab-pane fade" id="parts-panel" role="tabpanel" aria-labelledby="parts-tab">
      <h5 class="mb-2">ูุทุนุงุช ุดุฑฺฉุช</h5>
      <input id="partSearch" type="text" class="form-control form-control-sm mb-2" placeholder="ุฌุณุชุฌู ุฏุฑ ูุทุนุงุช...">
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle" id="partTable">
          <thead class="table-secondary">
            <tr>
              <th>#</th>
              <th>ูุงู ูุทุนู</th>
              <th>ุชุนุฏุงุฏ</th>
              <th>ฺฉุฏ ุดุฑฺฉุช</th>
              <th>ุงููุถุง</th>
              <th>ุนููุงุช</th>
            </tr>
          </thead>
          <tbody>
            {% for p in parts %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ p.name }}</td>
                <td>{{ p.quantity }}</td>
                <td>{{ p.company_code }}</td>
                <td>{{ p.expiry_date|default:"โ" }}</td>
                <td>
                  <!-- ุงฺฏุฑ ูู ุขูพุฏุช ุฏุงุฑ: -->
                  <a href="{% url 'update_part' p.id %}" class="btn btn-sm btn-primary">ูุฑุงุด</a>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="text-center text-muted">ูฺ ูุทุนูโุง ุซุจุช ูุดุฏู</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- 5) ุงูุจุงุฑูุง (Warehouse) -->
    <div class="tab-pane fade" id="warehouses-panel" role="tabpanel" aria-labelledby="warehouses-tab">
      <h5 class="mb-2">ุงูุจุงุฑูุง ุดุฑฺฉุช</h5>
      <!-- ุดุจู ุงูฺฏููุง ุจุงูุง: ุฌุณุชุฌู + ุฌุฏูู -->
    </div>

    <!-- 6) ุฒุฑุงูุจุงุฑูุง ุงูุจุงุฑ (WarehouseSubStorage) -->
    <div class="tab-pane fade" id="subwarehouses-panel" role="tabpanel" aria-labelledby="subwarehouses-tab">
      <h5 class="mb-2">ุฒุฑุงูุจุงุฑูุง ุงูุจุงุฑ</h5>
      <!-- ุฌุณุชุฌู + ุฌุฏูู -->
    </div>

    <!-- 7) ุฒุฑุงูุจุงุฑูุง ฺฉุดุช (ShipSubWarehouse) -->
    <div class="tab-pane fade" id="ship-subwarehouses-panel" role="tabpanel" aria-labelledby="ship-subwarehouses-tab">
      <h5 class="mb-2">ุฒุฑุงูุจุงุฑูุง ฺฉุดุช</h5>
      <!-- ุฌุณุชุฌู + ุฌุฏูู -->
    </div>

    <!-- 8) ุณูุฑูุง (TransportOperation) -->
    <div class="tab-pane fade" id="transport-panel" role="tabpanel" aria-labelledby="transport-tab">
      <h5 class="mb-2">ุณูุฑูุง ุดุฑฺฉุช</h5>
      <!-- ุฌุณุชุฌู + ุฌุฏูู -->
    </div>

    <!-- 9) ุงุฏุขูุฑโูุง (Reminder) -->
    <div class="tab-pane fade" id="reminders-panel" role="tabpanel" aria-labelledby="reminders-tab">
      <h5 class="mb-2">ุงุฏุขูุฑโูุง ุดุฑฺฉุช</h5>
      <!-- ุฌุณุชุฌู + ุฌุฏูู -->
    </div>

  </div> <!-- /tab-content -->
</div> <!-- /container -->

<!-- Modal ูุฑุงุด ฺฉุดุช (Ajax) -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="editModalLabel">ูุฑุงุด ฺฉุดุช</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ุจุณุชู"></button>
      </div>
      <div class="modal-body" id="editModalBody">
        <!-- ูุฑู ุจุง Ajax ููุฏ ูโุดูุฏ -->
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {

  // ูููุฏุงุฑ (Chart.js)
  const chartCanvas = document.getElementById('statsChart');
  if(chartCanvas) {
    const data = {
      labels: ['ฺฉุดุช', 'ุงูุจุงุฑ', 'ูุทุนู', 'ุณูุฑ', 'ฺฉุงุฑููุฏ'],
      datasets: [{
        label: 'ุชุนุฏุงุฏ',
        data: [
          {{ stats.ships }},
          {{ stats.warehouses }},
          {{ stats.parts }},
          {{ stats.transports }},
          {{ stats.employees }}
        ],
        backgroundColor: [
          'rgba(54, 162, 235, 0.8)',
          'rgba(255, 206, 86, 0.8)',
          'rgba(75, 192, 192, 0.8)',
          'rgba(153, 102, 255, 0.8)',
          'rgba(255, 99, 132, 0.8)'
        ]
      }]
    };
    const config = { type: 'pie', data: data };
    new Chart(chartCanvas, config);
  }

  // ุฌุณุชุฌู ุฏุฑ ุฌุฏูู ฺฉุงุฑููุฏุงู
  const empSearch = document.getElementById('employeeSearch');
  const empTable = document.getElementById('employeeTable');
  if (empSearch && empTable) {
    empSearch.addEventListener('keyup', () => {
      const query = empSearch.value.toLowerCase();
      const rows = empTable.getElementsByTagName('tr');
      for (let i = 1; i < rows.length; i++) {
        const rowText = rows[i].innerText.toLowerCase();
        rows[i].style.display = rowText.indexOf(query) > -1 ? '' : 'none';
      }
    });
  }

  // ุฌุณุชุฌู ุฏุฑ ุฌุฏูู ฺฉุดุชโูุง
  const shipSearch = document.getElementById('shipSearch');
  const shipTable = document.getElementById('shipTable');
  if (shipSearch && shipTable) {
    shipSearch.addEventListener('keyup', () => {
      const query = shipSearch.value.toLowerCase();
      const rows = shipTable.getElementsByTagName('tr');
      for (let i = 1; i < rows.length; i++) {
        const rowText = rows[i].innerText.toLowerCase();
        rows[i].style.display = rowText.indexOf(query) > -1 ? '' : 'none';
      }
    });
  }

  // ุฌุณุชุฌู ุฏุฑ ุฌุฏูู ูุทุนุงุช
  const partSearch = document.getElementById('partSearch');
  const partTable = document.getElementById('partTable');
  if (partSearch && partTable) {
    partSearch.addEventListener('keyup', () => {
      const query = partSearch.value.toLowerCase();
      const rows = partTable.getElementsByTagName('tr');
      for (let i = 1; i < rows.length; i++) {
        const rowText = rows[i].innerText.toLowerCase();
        rows[i].style.display = (rowText.indexOf(query) > -1) ? '' : 'none';
      }
    });
  }

});
</script>

<!-- ุงุณฺฉุฑูพุช ูุฑุงุด ููุฏุงู ฺฉุดุช -->
<script>
function openShipModal(shipId) {
  const url = `/ships/edit-modal/${shipId}/`;
  fetch(url)
    .then(resp => resp.text())
    .then(html => {
      const modalBody = document.getElementById('editModalBody');
      modalBody.innerHTML = html;
      const myModal = new bootstrap.Modal(document.getElementById('editModal'));
      myModal.show();
      
      // ููุฏู ุซุจุช ูุฑู
      const form = modalBody.querySelector('#shipEditForm');
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        fetch(url, {
          method: 'POST',
          body: formData
        })
        .then(r => r.json().catch(() => r.text()))
        .then(data => {
          if(data.status === 'ok') {
            alert(data.message);
            myModal.hide();
            window.location.reload();
          } else {
            // ุงฺฏุฑ ุงุฑูุฑ ูุฑู ุฏุงุดุช
            modalBody.innerHTML = data;
          }
        })
        .catch(err => console.error(err));
      });
    })
    .catch(err => console.error(err));
}

function deleteShipAjax(shipId, event) {
  if(!confirm("ุขุง ุงุฒ ุญุฐู ุงู ฺฉุดุช ูุทูุฆู ูุณุชุฏุ")) return;
  fetch(`/ships/delete-ajax/${shipId}/`, {
    method: 'POST',
    headers: {'X-CSRFToken': '{{ csrf_token }}'}
  })
  .then(resp => resp.json())
  .then(data => {
    if(data.status === 'ok') {
      alert("ฺฉุดุช ุจุง ููููุช ุญุฐู ุดุฏ.");
      const row = event.target.closest('tr');
      row.remove();
    } else {
      alert("ุฎุทุง ุฏุฑ ุญุฐู ฺฉุดุช");
    }
  })
  .catch(err => console.error(err));
}
</script>

<style>
/* ุทุฑุงุญ ุชุจโูุง ุจุง Nav Pills */
.nav-pills .nav-link.active {
  background-color: #6a11cb !important; /* ุจููุด */
  color: #fff !important;
}
.nav-pills .nav-link {
  color: #555;
  margin-right: .25rem;
}

/* ุงุณุชุงู ุฌุฏูู ุจุง ุณุฑุณุชูู ุฎุงฺฉุณุชุฑ ุฑูุดู */
.table-secondary th {
  background-color: #e2e3e5 !important;
  color: #333 !important;
}

/* ฺฉุงุฑุชโูุง */
.card {
  border-radius: .5rem;
}

/* ููุฏุงู */
.modal-content {
  border-radius: .75rem;
}
</style>
{% endblock %}
